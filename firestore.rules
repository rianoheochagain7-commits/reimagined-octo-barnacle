rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Boots collection - marketplace listings
    match /boots/{bootId} {
      allow read: if isAuthenticated() && resource.data.isActive == true;
      allow read: if isAuthenticated() && resource.data.sellerId == request.auth.uid;
      allow create: if isAuthenticated() 
                    && request.resource.data.sellerId == request.auth.uid
                    && request.resource.data.isActive == true;
      allow update: if isAuthenticated() 
                    && resource.data.sellerId == request.auth.uid
                    && resource.data.sellerId == request.auth.uid;
      allow update: if isAuthenticated() 
                    && request.resource.data.buyerId == request.auth.uid
                    && request.resource.data.isActive == false
                    && request.resource.data.sellerId == resource.data.sellerId;
      allow delete: if isAuthenticated() 
                    && resource.data.sellerId == request.auth.uid;
    }
    
    match /boots/{document=**} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
    }
    
    // Users collection - user profiles
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() 
                    && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['email', 'displayName', 'photoURL', 'uid']));
    }
    
    // Orders collection - purchase history with escrow status
    match /orders/{orderId} {
      // Users can read their own orders (as buyer or seller)
      allow read: if isAuthenticated() 
                  && (resource.data.buyerId == request.auth.uid 
                      || resource.data.sellerId == request.auth.uid);
      
      // Buyers can create orders when purchasing
      allow create: if isAuthenticated() 
                    && request.resource.data.buyerId == request.auth.uid
                    && request.resource.data.sellerId != null
                    && request.resource.data.bootId != null
                    && request.resource.data.status == "paid"; // Initial status must be "paid" (escrow)
      
      // Buyers and sellers can update their own orders (status updates)
      allow update: if isAuthenticated() 
                    && (resource.data.buyerId == request.auth.uid 
                        || resource.data.sellerId == request.auth.uid)
                    && // Only allow valid status transitions
                    (request.resource.data.status == "shipped" 
                     || request.resource.data.status == "delivered"
                     || request.resource.data.status == "completed"
                     || request.resource.data.status == "refunded");
      
      // Only seller can mark as shipped
      allow update: if isAuthenticated()
                    && resource.data.sellerId == request.auth.uid
                    && resource.data.status == "paid"
                    && request.resource.data.status == "shipped";
      
      // Only buyer can mark as delivered
      allow update: if isAuthenticated()
                    && resource.data.buyerId == request.auth.uid
                    && resource.data.status == "shipped"
                    && request.resource.data.status == "delivered";
      
      // Only buyer can request refund
      allow update: if isAuthenticated()
                    && resource.data.buyerId == request.auth.uid
                    && request.resource.data.status == "refunded";
    }
    
    // Reviews collection - buyer/seller reviews
    match /reviews/{reviewId} {
      // Anyone authenticated can read reviews
      allow read: if isAuthenticated();
      
      // Users can create reviews for their own orders
      allow create: if isAuthenticated() 
                    && request.resource.data.reviewerId == request.auth.uid
                    && request.resource.data.orderId != null
                    && request.resource.data.rating >= 1
                    && request.resource.data.rating <= 5;
      
      // Users can update their own reviews (only helpful count)
      allow update: if isAuthenticated() 
                    && resource.data.reviewerId == request.auth.uid
                    && request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['helpfulCount']);
      
      // Users can mark reviews as helpful (increment helpfulCount)
      // Note: This would need a separate collection or different approach
      // For now, only reviewer can update helpfulCount
    }
    
    // Reports collection - user reports for moderation
    match /reports/{reportId} {
      allow create: if isAuthenticated() 
                    && request.resource.data.reporterId == request.auth.uid;
      allow read: if isAuthenticated();
    }
    
    // BlockedUsers collection - user blocking
    match /blockedUsers/{blockId} {
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid;
    }
    
    // Follows collection - follow relationships
    match /follows/{followId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
                    && request.resource.data.followerId == request.auth.uid
                    && request.resource.data.followingId != request.auth.uid;
      allow delete: if isAuthenticated() 
                    && resource.data.followerId == request.auth.uid;
    }
    
    // Conversations collection - chat conversations
    // SIMPLIFIED RULES - More permissive for testing
    match /conversations/{conversationId} {
      // Allow authenticated users to read/create/update conversations
      allow read, write: if isAuthenticated();
      
      // Messages subcollection
      match /messages/{messageId} {
        // Allow authenticated users to read/write messages
        allow read, write: if isAuthenticated();
      }
    }
  }
}
